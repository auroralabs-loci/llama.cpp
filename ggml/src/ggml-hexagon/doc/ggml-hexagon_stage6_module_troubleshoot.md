# 6. 模块问题排查

## 模块出现问题的可能原因

- **1. 环境配置问题**:
  - Hexagon SDK 版本不兼容。
  - 环境变量（如 `HEXAGON_SDK_ROOT`）未正确设置。
  - 编译选项不正确。
- **2. 硬件或驱动问题**:
  - 设备不支持 Hexagon DSP。
  - DSP 驱动版本过低。
  - 硬件故障。
- **3. 代码 Bug**:
  - **CPU 端**:
    - 内存管理错误（如内存泄漏、越界访问）。
    - 任务调度逻辑错误。
    - 数据同步问题。
  - **DSP 端**:
    - 计算内核实现错误。
    - HVX 指令使用不当。
    - 线程同步问题（如死锁）。
- **4. 数据问题**:
  - 输入数据格式不正确。
  - 输入数据中包含 NaN 或 Inf。

## 模块排查步骤

1.  **检查配置和环境**:
    - 确认 Hexagon SDK 版本是否与项目要求一致。
    - 检查所有相关的环境变量是否已正确设置。
    - 清理并重新编译整个项目。

2.  **运行最小可复现示例**:
    - 使用一个最简单的模型和输入，看问题是否能够复现。
    - 如果最小示例可以正常运行，说明问题可能与特定的模型或数据有关。

3.  **查看日志**:
    - 仔细检查 `ggml` 和 `ggml-hexagon` 输出的日志，查找错误或警告信息。
    - 增加更详细的日志输出，以定位问题发生的代码位置。

4.  **分段排查**:
    - **禁用 Hexagon 后端**: 临时禁用 `ggml-hexagon` 后端，看问题是否消失。如果问题消失，说明是 `ggml-hexagon` 模块的问题。
    - **CPU-DSP 边界排查**: 在 `ggml-hexagon.cpp` 中，检查发送到 DSP 的数据是否正确，以及从 DSP 返回的数据是否符合预期。
    - **DSP 内部排查**: 使用 `hexagon-gdb` 来单步调试 DSP 上的代码，检查计算过程中的中间结果。

5.  **硬件和驱动检查**:
    - 在另一台相同型号的设备上运行，看问题是否能够复现。
    - 检查设备的系统更新，确保 DSP 驱动是最新版本。

6.  **代码审查 (Code Review)**:
    - 仔细审查最近的代码变更，看是否有可能引入问题的修改。
    - 请求其他同事对相关的代码进行审查。
