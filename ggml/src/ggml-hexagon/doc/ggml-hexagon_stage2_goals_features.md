# 2. 项目目标、演进与关键特性

## 项目目标与演进

- **短期目标**:
  - 将 `ggml` 中最耗时的计算操作（如矩阵乘法、量化）卸载到 Hexagon DSP，以显著提升在移动设备上的性能。
  - 支持最常见的 `ggml` 数据类型和操作，确保与主流模型的兼容性。

- **长期目标**:
  - 成为 `ggml` 在 Qualcomm 平台上的首选后端。
  - 持续优化性能，跟进 Hexagon DSP 的新特性。
  - 扩展支持的操作范围，以覆盖更多模型。

- **演进路径**:
  - **v1**: 实现核心的矩阵乘法和量化操作。
  - **v2**: 增加对更多激活函数和归一化操作的支持。
  - **v3**: 优化数据传输和内存管理，减少 CPU 和 DSP 之间的开销。
  - **v4**: 支持混合精度计算，进一步提升性能。

## 核心组件、关键特性与核心功能

- **核心组件**:
  - **`ggml_hexagon_session`**: 管理与 DSP 的会话，包括初始化、资源分配和任务提交。
  - **`ggml_backend_hexagon_buffer`**: 管理在 DSP 上分配的内存，处理数据传输。
  - **HTP (Hexagon Tensor Processor) 内核**: 在 DSP 上执行的实际计算代码，位于 `htp/` 目录下。

- **关键特性**:
  - **DSP 卸载**: 将计算密集型任务从 CPU 卸载到低功耗、高性能的 DSP。
  - **HVX 加速**: 利用 Hexagon Vector eXtensions (HVX) SIMD 引擎来加速计算。
  - **异步执行**: CPU 和 DSP 可以并行工作，提升整体效率。

- **核心功能/算法**:
  - **量化/反量化**: 支持 `Q4_0`, `Q8_0` 等量化类型，包括在 CPU 和 DSP 之间传输时的打包/解包逻辑。
  - **矩阵乘法**: 优化的 `mul_mat` 实现，是 Transformer 模型中的核心操作。
  - **激活函数**: 实现了 `silu`, `gelu` 等常用的激活函数。
  - **归一化**: 实现了 `rms_norm` 等归一化操作。

- **时间/空间复杂度**:
  - **矩阵乘法**: 时间复杂度为 O(N*M*K)，空间复杂度为 O(N*M + M*K + N*K)。通过 DSP 加速，实际执行时间会远小于在 CPU 上的执行时间。
  - **数据传输**: 传输开销与数据大小成正比，是性能优化的关键点之一。

## 关键用例

- **用例：在手机上运行一个大型语言模型**
  1. 用户在手机上启动一个使用 `ggml` 的应用（如聊天机器人）。
  2. 应用加载模型，`ggml` 检测到设备支持 Hexagon DSP，并初始化 `ggml-hexagon` 后端。
  3. 用户输入文本，模型开始进行推理。
  4. 在推理过程中，`ggml` 将矩阵乘法等计算任务卸载到 `ggml-hexagon` 后端。
  5. `ggml-hexagon` 将任务发送到 DSP 执行。
  6. DSP 高效地完成计算，并将结果返回给 CPU。
  7. CPU 继续后续的计算，并将最终结果呈现给用户。
  8. 用户感受到流畅的交互，而手机的功耗和发热也得到了很好的控制。
